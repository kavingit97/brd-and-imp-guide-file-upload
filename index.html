<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Clickable Component Detection</title>
    <style>
        body { font-family: Arial, sans-serif; }
        .output-section { position: relative; }
        .spinner { display: none; }
    </style>
    <script async src="https://docs.opencv.org/4.5.3/opencv.js"></script>
</head>
<body>

<h1>Image Upload and Detection</h1>
<form id="inputForm">
    <input type="file" id="fileInput" accept="image/*" required>
    <button type="submit">Process</button>
    <div class="spinner" id="spinner">Loading...</div>
</form>

<div class="output-section" id="outputSection"></div>

<script>
    document.getElementById('inputForm').addEventListener('submit', function(event) {
        event.preventDefault();

        const fileInput = document.getElementById('fileInput').files[0];
        const reader = new FileReader();
        const outputSection = document.getElementById('outputSection');
        outputSection.innerHTML = ''; // Clear previous output
        const spinner = document.getElementById('spinner');
        spinner.style.display = 'block';

        reader.onload = function(e) {
            const imgElement = document.createElement('img');
            imgElement.src = e.target.result;
            imgElement.onload = function() {
                cv.onRuntimeInitialized = () => {
                    const canvas = document.createElement('canvas');
                    canvas.width = imgElement.width;
                    canvas.height = imgElement.height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(imgElement, 0, 0);
                    const src = cv.imread(canvas);
                    const dst = new cv.Mat();

                    // Image processing steps
                    cv.cvtColor(src, src, cv.COLOR_RGBA2GRAY); // Grayscale
                    cv.GaussianBlur(src, src, new cv.Size(5, 5), 0); // Blur
                    cv.Canny(src, dst, 100, 200); // Edge detection

                    // Draw processed image for debugging
                    const processedCanvas = document.createElement('canvas');
                    processedCanvas.width = canvas.width;
                    processedCanvas.height = canvas.height;
                    cv.imshow(processedCanvas, dst);
                    outputSection.appendChild(processedCanvas);

                    // Find contours
                    const contours = new cv.MatVector();
                    const hierarchy = new cv.Mat();
                    cv.findContours(dst, contours, hierarchy, cv.RETR_CCOMP, cv.CHAIN_APPROX_SIMPLE);

                    // Process contours to identify clickable components
                    for (let i = 0; i < contours.size(); i++) {
                        const c = contours.get(i);
                        const rect = cv.boundingRect(c);
                        if (rect.width > 30 && rect.height > 30) { // Size threshold
                            drawRectangle(outputSection, rect.x, rect.y, rect.width, rect.height);
                        }
                    }

                    // Clean up
                    src.delete();
                    dst.delete();
                    contours.delete();
                    hierarchy.delete();
                    spinner.style.display = 'none';
                };
            };
            outputSection.appendChild(imgElement); // Show the original image
        };
        reader.readAsDataURL(fileInput);
    });

    function drawRectangle(outputDiv, x, y, width, height) {
        const rect = document.createElement('div');
        rect.style.position = 'absolute';
        rect.style.border = '2px solid red';
        rect.style.left = `${x}px`;
        rect.style.top = `${y}px`;
        rect.style.width = `${width}px`;
        rect.style.height = `${height}px`;
        outputDiv.appendChild(rect);
    }
</script>

</body>
</html>
